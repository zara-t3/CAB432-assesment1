{% extends "template.html" %}
{% block content %}
  <h1 class="h4 mb-3">My Images</h1>

  <div class="d-flex flex-wrap gap-2 mb-3">
    <button id="refreshBtn" class="btn btn-outline-secondary">Refresh</button>

    <div class="input-group input-group-sm" style="width: 180px;">
      <span class="input-group-text">limit</span>
      <input id="imgLimit" type="number" class="form-control" value="10" min="1" />
    </div>

    <div class="input-group input-group-sm" style="width: 180px;">
      <span class="input-group-text">offset</span>
      <input id="imgOffset" type="number" class="form-control" value="0" min="0" />
    </div>
  </div>

  <div id="imagesTableWrap"></div>
{% endblock %}

{% block scripts %}
<script>
// ---------- UI helpers ----------
function kb(n){ return n ? Math.round(n/1024) : 0; }
function fmtDate(s){ return s ? s.replace('T',' ').slice(0,19) : ''; }

// Renders one row. We include buttons for view, download and a variants dropdown.
function imgRow(i, index) {
  const created   = fmtDate(i.created_at);
  const processed = i.processed_path ? '<span class="badge bg-success">processed</span>' : '';
  const variants  = (i.variants || []);
  const dropId    = `variantsMenu-${index}`;

  // Build variants dropdown items (if any)
  const variantItems = variants.length
    ? variants.map(v => `
      <li>
        <button class="dropdown-item"
                onclick="openVariant('${i.id}', '${v.name}')">
          ${v.name} <span class="text-muted">(${kb(v.size_bytes)} KB)</span>
        </button>
      </li>`).join("")
    : `<li><span class="dropdown-item-text text-muted">No variants</span></li>`;

  // Variants dropdown button (only shown if variants exist)
  const variantsBtn = `
    <div class="btn-group">
      <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle"
              data-bs-toggle="dropdown" aria-expanded="false">
        Variants
      </button>
      <ul class="dropdown-menu dropdown-menu-end" id="${dropId}">
        ${variantItems}
      </ul>
    </div>`;

  return `<tr>
    <td class="text-truncate" style="max-width:260px;"><code>${i.id}</code></td>
    <td>${i.owner}</td>
    <td>${created}</td>
    <td>${processed}</td>
    <td class="d-flex flex-wrap gap-2">
      <button class="btn btn-link p-0" onclick="openImage('${i.id}','original')">View original</button>
      ${i.processed_path ? `
        <span class="text-muted">|</span>
        <button class="btn btn-link p-0" onclick="openImage('${i.id}','processed')">View processed</button>
        <span class="text-muted">|</span>
        <button class="btn btn-link p-0" onclick="downloadProcessed('${i.id}')">Download</button>
        <span class="text-muted">|</span>
        ${variantsBtn}
      ` : ''}
      <span class="text-muted">|</span>
      <a class="link-primary" href="/jobs" onclick="localStorage.setItem('last_image_id','${i.id}')">
        use for job
      </a>
    </td>
  </tr>`;
}

// ---------- Network helpers (use token header) ----------
async function openImage(id, version) {
  const token = getToken();
  if (!token) return window.location.href = "/login";

  const res = await fetch(`${BASE}/images/${id}/file?version=${encodeURIComponent(version)}`, {
    headers: { Authorization: "Bearer " + token }
  });
  if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  window.open(url, "_blank");
  setTimeout(() => URL.revokeObjectURL(url), 10000);
}

async function downloadProcessed(id) {
  try {
    const token = getToken();
    if (!token) return window.location.href = "/login";

    const res = await fetch(`${BASE}/images/${id}/file?version=processed&download=1`, {
      headers: { Authorization: "Bearer " + token }
    });
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);

    const cd = res.headers.get("Content-Disposition");
    const suggested = (cd && cd.split("filename=").pop()?.replace(/(^"|"$)/g,"")) || `processed_${id}.jpg`;

    const blob = await res.blob();
    const url  = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = suggested;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  } catch (e) {
    alert("Download failed: " + e.message);
  }
}

async function openVariant(id, name) {
  try {
    const token = getToken();
    if (!token) return window.location.href = "/login";

    const res = await fetch(`${BASE}/images/${id}/file?variant=${encodeURIComponent(name)}`, {
      headers: { Authorization: "Bearer " + token }
    });
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);

    const blob = await res.blob();
    const url  = URL.createObjectURL(blob);
    window.open(url, "_blank");
    setTimeout(() => URL.revokeObjectURL(url), 10000);
  } catch (e) {
    alert("Open variant failed: " + e.message);
  }
}

// ---------- Table loader ----------
async function loadImages() {
  try {
    const token = getToken();
    if (!token) return window.location.href = "/login";

    const limit  = Number(document.getElementById("imgLimit").value) || 10;
    const offset = Number(document.getElementById("imgOffset").value) || 0;

    const j = await api(`/images?limit=${limit}&offset=${offset}`);
    const rows = j.items.map((img, idx) => imgRow(img, idx)).join("");

    document.getElementById("imagesTableWrap").innerHTML =
      `<div class="text-muted mb-2">total: ${j.total}</div>
       <div class="table-responsive">
         <table class="table table-striped table-sm align-middle">
           <thead>
             <tr><th>ID</th><th>Owner</th><th>Created</th><th>Status</th><th>Actions</th></tr>
           </thead>
           <tbody>${rows}</tbody>
         </table>
       </div>`;
  } catch (e) {
    alert("Load images failed: " + e.message);
  }
}

document.getElementById("refreshBtn").addEventListener("click", loadImages);
loadImages();
</script>
{% endblock %}
