{% extends "template.html" %}
{% block content %}
  <h1 class="h4 mb-3">My Images</h1>

  <div class="card">
    <div class="card-body table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th scope="col">Thumbnail</th>
            <th scope="col">Name</th>
            <th scope="col">ID</th>
            <th scope="col">Owner</th>
            <th scope="col">Created</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody id="imagesTableBody">
          <!-- rows injected by JS -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Metadata Modal -->
  <div class="modal fade" id="metadataModal" tabindex="-1" aria-labelledby="metadataModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="metadataModalLabel" style="color: var(--chocolate-brown);">Processing Metadata</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="metadataContent">
            <div class="text-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
async function loadImages() {
  try {
    const j = await api("/images");
    const body = document.getElementById("imagesTableBody");
    body.innerHTML = "";

    j.items.forEach(i => {
      const tr = document.createElement("tr");

      const tdThumb = document.createElement("td");
      tdThumb.style.width = "120px";
      tdThumb.innerHTML = `
        <div class="ratio ratio-1x1" style="max-width:96px;">
          <img id="thumb_${i.id}" alt="thumb" class="rounded border" style="object-fit:cover;">
        </div>`;
      tr.appendChild(tdThumb);

      // Name
      const tdName = document.createElement("td");
      tdName.textContent = i.name || "—";
      tr.appendChild(tdName);

      // ID
      const tdId = document.createElement("td");
      tdId.textContent = i.id;
      tr.appendChild(tdId);

      // Owner
      const tdOwner = document.createElement("td");
      tdOwner.textContent = i.owner;
      tr.appendChild(tdOwner);

      // Created
      const tdCreated = document.createElement("td");
      tdCreated.textContent = new Date(i.created_at).toLocaleString();
      tr.appendChild(tdCreated);

      // Actions
      const tdActions = document.createElement("td");
      tdActions.style.minWidth = "300px";

      const actionsDiv = document.createElement("div");
      actionsDiv.className = "d-flex flex-column gap-1";

      // First row of buttons
      const topRow = document.createElement("div");
      topRow.className = "d-flex gap-1";

      const viewBtn = document.createElement("button");
      viewBtn.className = "btn btn-sm btn-link p-1";
      viewBtn.style.fontSize = "0.75rem";
      viewBtn.textContent = "View original";
      viewBtn.onclick = () => openImage(i.id, "original");
      topRow.appendChild(viewBtn);

      if (i.processed_path) {
        const viewProc = document.createElement("button");
        viewProc.className = "btn btn-sm btn-link p-1";
        viewProc.style.fontSize = "0.75rem";
        viewProc.textContent = "View processed";
        viewProc.onclick = () => openImage(i.id, "processed");
        topRow.appendChild(viewProc);

        actionsDiv.appendChild(topRow);

        const bottomRow = document.createElement("div");
        bottomRow.className = "d-flex gap-1";

        const dlBtn = document.createElement("button");
        dlBtn.className = "btn btn-sm btn-outline-secondary p-1";
        dlBtn.style.fontSize = "0.75rem";
        dlBtn.textContent = "Download";
        dlBtn.onclick = () => downloadImage(i.id, "processed");
        bottomRow.appendChild(dlBtn);

        const metaBtn = document.createElement("button");
        metaBtn.className = "btn btn-sm btn-outline-secondary p-1";
        metaBtn.style.fontSize = "0.75rem";
        metaBtn.textContent = "Metadata";
        metaBtn.onclick = () => showMetadata(i.id);
        bottomRow.appendChild(metaBtn);

        actionsDiv.appendChild(bottomRow);
      } else {
        const blurBtn = document.createElement("button");
        blurBtn.className = "btn btn-sm btn-primary p-1";
        blurBtn.style.fontSize = "0.75rem";
        blurBtn.textContent = "Blur faces";
        blurBtn.onclick = () => goBlur(i.id);
        topRow.appendChild(blurBtn);
        actionsDiv.appendChild(topRow);
      }

      tdActions.appendChild(actionsDiv);
      tr.appendChild(tdActions);
      body.appendChild(tr);
    });

    await loadThumbs(j.items.map(x => x.id));
  } catch (e) {
    alert("Failed to load images: " + e.message);
  }
}

async function loadThumbs(ids) {
  const token = getToken();
  if (!token) return;
  for (const id of ids) {
    try {
      const res = await fetch(`${BASE}/images/${id}/file?version=thumb`, {
        headers: { Authorization: "Bearer " + token }
      });
      if (!res.ok) continue;
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const img = document.getElementById(`thumb_${id}`);
      if (img) {
        img.src = url;
        img.onload = () => setTimeout(() => URL.revokeObjectURL(url), 10000);
      }
    } catch (_) { }
  }
}

async function openImage(id, version) {
  const token = getToken();
  if (!token) return window.location.href = "/login";
  const res = await fetch(`${BASE}/images/${id}/file?version=${version}`, {
    headers: { Authorization: "Bearer " + token }
  });
  if (!res.ok) return alert(`Open failed: ${res.status} ${res.statusText}`);
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  window.open(url, "_blank");
  setTimeout(() => URL.revokeObjectURL(url), 10000);
}

async function downloadImage(id, version) {
  const token = getToken();
  const res = await fetch(`${BASE}/images/${id}/file?version=${version}&download=1`, {
    headers: { Authorization: "Bearer " + token }
  });
  if (!res.ok) return alert(`Download failed: ${res.status} ${res.statusText}`);
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `${id}_${version}.jpg`;
  a.click();
  setTimeout(() => URL.revokeObjectURL(url), 10000);
}
async function showMetadata(imageId) {
  const modal = new bootstrap.Modal(document.getElementById('metadataModal'));
  modal.show();
  
  try {
    const metadata = await api(`/images/${imageId}/metadata`);
    
    const content = document.getElementById('metadataContent');
    content.innerHTML = `
      <div class="card">
        <div class="card-body">
          <h6 class="card-title mb-3" style="color: var(--chocolate-brown);">Processing Summary</h6>
          <div class="row g-2">
            <div class="col-sm-6">
              <span style="color: var(--chocolate-brown); font-size: 0.875rem;">Faces Detected:</span>
              <span style="color: black;" class="ms-1">${metadata.faces_detected}</span>
            </div>
            <div class="col-sm-6">
              <span style="color: var(--chocolate-brown); font-size: 0.875rem;">Blur Strength:</span>
              <span style="color: black;" class="ms-1">${metadata.blur_strength}</span>
            </div>
            <div class="col-sm-6">
              <span style="color: var(--chocolate-brown); font-size: 0.875rem;">Extra Passes:</span>
              <span style="color: black;" class="ms-1">${metadata.extra_passes}</span>
            </div>
            <div class="col-sm-6">
              <span style="color: var(--chocolate-brown); font-size: 0.875rem;">Original Size:</span>
              <span style="color: black;" class="ms-1">${metadata.original_size[0]} × ${metadata.original_size[1]}</span>
            </div>
            <div class="col-sm-6">
              <span style="color: var(--chocolate-brown); font-size: 0.875rem;">Processing Time:</span>
              <span style="color: black;" class="ms-1">${new Date(metadata.processing_time * 1000).toLocaleString()}</span>
            </div>
            <div class="col-sm-6">
              <span style="color: var(--chocolate-brown); font-size: 0.875rem;">Image Dimensions:</span>
              <span style="color: black;" class="ms-1">${metadata.original_size[0]} × ${metadata.original_size[1]} pixels</span>
            </div>
          </div>
        </div>
      </div>
    `;
    
  } catch (e) {
    const content = document.getElementById('metadataContent');
    content.innerHTML = `
      <div class="alert" role="alert">
        <strong>Metadata not available</strong><br>
        <small class="text-muted">${e.message}</small>
      </div>
    `;
  }
}

function goBlur(id) {
  localStorage.setItem("last_image_id", id);
  window.location.href = "/jobs";
}

document.addEventListener("DOMContentLoaded", loadImages);
</script>
{% endblock %}
