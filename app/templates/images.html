{% extends "template.html" %}
{% block content %}
  <h1 class="h4 mb-3">My Images</h1>
  <div class="d-flex flex-wrap gap-2 mb-2">
    <button id="refreshBtn" class="btn btn-outline-secondary">Refresh</button>
    <div class="input-group input-group-sm" style="width: 180px;">
      <span class="input-group-text">limit</span>
      <input id="imgLimit" type="number" class="form-control" value="10" min="1" />
    </div>
    <div class="input-group input-group-sm" style="width: 180px;">
      <span class="input-group-text">offset</span>
      <input id="imgOffset" type="number" class="form-control" value="0" min="0" />
    </div>
  </div>
  <div id="imagesTableWrap"></div>
{% endblock %}
{% block scripts %}
<script>
function imgRow(i) {
  const created = i.created_at ? i.created_at.replace('T',' ').slice(0,19) : '';
  const processed = i.processed_path ? '<span class="badge bg-success">processed</span>' : '';
  return `<tr>
    <td><code>${i.id}</code></td>
    <td>${i.owner}</td>
    <td>${created}</td>
    <td>${processed}</td>
    <td>
      <a href="${BASE}/images/${i.id}/file?version=original" target="_blank">original</a>
      ${i.processed_path ? ` | <a href="${BASE}/images/${i.id}/file?version=processed" target="_blank">processed</a>` : ''}
      | <a href="/jobs" onclick="localStorage.setItem('last_image_id','${i.id}')">use for job</a>
    </td>
  </tr>`;
}
async function loadImages() {
  try {
    const limit  = Number(document.getElementById("imgLimit").value) || 10;
    const offset = Number(document.getElementById("imgOffset").value) || 0;
    const j = await api(`/images?limit=${limit}&offset=${offset}`);
    document.getElementById("imagesTableWrap").innerHTML =
      `<div class="text-muted mb-2">total: ${j.total}</div>
       <table class="table table-striped table-sm">
         <thead><tr><th>ID</th><th>Owner</th><th>Created</th><th>Status</th><th>Actions</th></tr></thead>
         <tbody>${j.items.map(imgRow).join("")}</tbody>
       </table>`;
  } catch (e) {
    alert("Load images failed: " + e.message);
  }
}
document.getElementById("refreshBtn").addEventListener("click", loadImages);
loadImages();
</script>
{% endblock %}
