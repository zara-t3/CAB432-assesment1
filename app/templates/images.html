{% extends "template.html" %}
{% block content %}
  <h1 class="h4 mb-3">My Images</h1>

  <div class="card">
    <div class="card-body table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th scope="col">Thumbnail</th>
            <th scope="col">Name</th>
            <th scope="col">ID</th>
            <th scope="col">Owner</th>
            <th scope="col">Created</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody id="imagesTableBody">
          <!-- rows injected by JS -->
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
// Load list, render rows, then load thumbnails with auth
async function loadImages() {
  try {
    const j = await api("/images");
    const body = document.getElementById("imagesTableBody");
    body.innerHTML = "";

    j.items.forEach(i => {
      const tr = document.createElement("tr");

      // Thumbnail cell (placeholder <img>, we fill src after auth fetch)
      const tdThumb = document.createElement("td");
      tdThumb.style.width = "120px";
      tdThumb.innerHTML = `
        <div class="ratio ratio-1x1" style="max-width:96px;">
          <img id="thumb_${i.id}" alt="thumb" class="rounded border" style="object-fit:cover;">
        </div>`;
      tr.appendChild(tdThumb);

      // Name
      const tdName = document.createElement("td");
      tdName.textContent = i.name || "â€”";
      tr.appendChild(tdName);

      // ID
      const tdId = document.createElement("td");
      tdId.textContent = i.id;
      tr.appendChild(tdId);

      // Owner
      const tdOwner = document.createElement("td");
      tdOwner.textContent = i.owner;
      tr.appendChild(tdOwner);

      // Created
      const tdCreated = document.createElement("td");
      tdCreated.textContent = new Date(i.created_at).toLocaleString();
      tr.appendChild(tdCreated);

      // Actions
      const tdActions = document.createElement("td");

      const viewBtn = document.createElement("button");
      viewBtn.className = "btn btn-sm btn-link";
      viewBtn.textContent = "View original";
      viewBtn.onclick = () => openImage(i.id, "original");
      tdActions.appendChild(viewBtn);

      if (i.processed_path) {
        const viewProc = document.createElement("button");
        viewProc.className = "btn btn-sm btn-link ms-2";
        viewProc.textContent = "View processed";
        viewProc.onclick = () => openImage(i.id, "processed");
        tdActions.appendChild(viewProc);

        const dlBtn = document.createElement("button");
        dlBtn.className = "btn btn-sm btn-outline-secondary ms-2";
        dlBtn.textContent = "Download processed";
        dlBtn.onclick = () => downloadImage(i.id, "processed");
        tdActions.appendChild(dlBtn);
      } else {
        const blurBtn = document.createElement("button");
        blurBtn.className = "btn btn-sm btn-primary ms-2";
        blurBtn.textContent = "Blur face/s";
        blurBtn.onclick = () => goBlur(i.id);
        tdActions.appendChild(blurBtn);
      }

      tr.appendChild(tdActions);
      body.appendChild(tr);
    });

    // After rows exist, fetch thumbnails with Authorization
    await loadThumbs(j.items.map(x => x.id));
  } catch (e) {
    alert("Failed to load images: " + e.message);
  }
}

async function loadThumbs(ids) {
  const token = getToken();
  if (!token) return;
  for (const id of ids) {
    try {
      const res = await fetch(`${BASE}/images/${id}/file?version=thumb`, {
        headers: { Authorization: "Bearer " + token }
      });
      if (!res.ok) continue;
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const img = document.getElementById(`thumb_${id}`);
      if (img) {
        img.src = url;
        img.onload = () => setTimeout(() => URL.revokeObjectURL(url), 10000);
      }
    } catch (_) { /* ignore per-thumb failure */ }
  }
}

async function openImage(id, version) {
  const token = getToken();
  if (!token) return window.location.href = "/login";
  const res = await fetch(`${BASE}/images/${id}/file?version=${version}`, {
    headers: { Authorization: "Bearer " + token }
  });
  if (!res.ok) return alert(`Open failed: ${res.status} ${res.statusText}`);
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  window.open(url, "_blank");
  setTimeout(() => URL.revokeObjectURL(url), 10000);
}

async function downloadImage(id, version) {
  const token = getToken();
  const res = await fetch(`${BASE}/images/${id}/file?version=${version}&download=1`, {
    headers: { Authorization: "Bearer " + token }
  });
  if (!res.ok) return alert(`Download failed: ${res.status} ${res.statusText}`);
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `${id}_${version}.jpg`;
  a.click();
  setTimeout(() => URL.revokeObjectURL(url), 10000);
}

function goBlur(id) {
  localStorage.setItem("last_image_id", id);
  window.location.href = "/jobs";
}

document.addEventListener("DOMContentLoaded", loadImages);
</script>
{% endblock %}
