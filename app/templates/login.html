{% extends "template.html" %}
{% block content %}
  <h1 class="h4 mb-3">Login</h1>
  
  <!-- Google Login Section -->
  <div class="card mb-3">
    <div class="card-body text-center">
      <h6 class="card-title">Quick Login</h6>
      <button id="googleLoginBtn" class="btn btn-danger d-flex align-items-center justify-content-center mx-auto" style="width: fit-content;">
        <i class="fab fa-google me-2"></i>Login with Google
      </button>
      <small class="d-block text-muted mt-2">Or use your ImageLab account below</small>
    </div>
  </div>
  
  <!-- Login Form -->
  <div id="loginSection">
    <div class="card">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-12 col-md-5">
            <label class="form-label">Username</label>
            <input id="username" class="form-control" value="" />
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label">Password</label>
            <input id="password" class="form-control" type="password" value="" />
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label">&nbsp;</label>
            <button id="loginFormBtn" type="button" class="btn btn-primary w-100 d-block" onclick="handleLogin()">Login</button>
          </div>
        </div>
        <div class="text-center mt-2">
          <small class="text-muted">
            Need an account? <a href="#" onclick="showSignup()">Sign up here</a>
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- MFA Challenge Section (Hidden Initially) -->
  <div id="mfaSection" class="d-none">
    <div class="card">
      <div class="card-body">
        <h5>Email Verification Required</h5>
        <div id="mfaMessage" class="alert alert-info">
          Please check your email for a verification code.
        </div>
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label">Verification Code</label>
            <input id="mfaCode" type="text" class="form-control" placeholder="Enter 6-digit code" maxlength="6" autocomplete="one-time-code">
            <div class="form-text">Enter the 6-digit code sent to your email address</div>
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label">&nbsp;</label>
            <button id="verifyMfaBtn" class="btn btn-primary w-100 d-block">Verify Code</button>
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label">&nbsp;</label>
            <button class="btn btn-outline-secondary w-100 d-block" onclick="backToLogin()">Back to Login</button>
          </div>
        </div>
        
        <!-- Helpful info for users -->
        <div class="mt-3">
          <small class="text-muted">
            <strong>Tip:</strong> Check your spam folder if you don't see the email. 
            The code is valid for a few minutes.
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- Signup Form (Hidden Initially) -->
  <div id="signupSection" class="d-none">
    <div class="card">
      <div class="card-body">
        <h5>Create Account</h5>
        <div class="row g-3">
          <div class="col-12 col-lg-3">
            <label class="form-label">Username</label>
            <input id="signupUsername" class="form-control" />
          </div>
          <div class="col-12 col-lg-3">
            <label class="form-label">Email</label>
            <input id="signupEmail" class="form-control" type="email" />
          </div>
          <div class="col-12 col-lg-4">
            <label class="form-label">Password</label>
            <input id="signupPassword" class="form-control" type="password" />
            <div class="form-text">8+ chars, number, upper, lower, symbol</div>
          </div>
          <div class="col-12 col-lg-2">
            <label class="form-label">&nbsp;</label>
            <button id="signupBtn" class="btn btn-primary w-100 d-block">Sign Up</button>
          </div>
        </div>
        <div class="text-center mt-2">
          <small class="text-muted">
            <a href="#" onclick="showLogin()">Back to login</a> | 
            <a href="#" onclick="showConfirm()">Have confirmation code?</a>
          </small>
        </div>
      </div>
    </div>
  </div>

  <div id="confirmSection" class="d-none">
    <div class="card">
      <div class="card-body">
        <h5>Confirm Email</h5>
        <div class="alert alert-info">
          Check your email for a 6-digit confirmation code to activate your account.
        </div>
        <div class="row g-3">
          <div class="col-12 col-md-5">
            <label class="form-label">Username</label>
            <input id="confirmUsername" class="form-control" />
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label">Confirmation Code</label>
            <input id="confirmCode" class="form-control" placeholder="123456" maxlength="6" />
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label">&nbsp;</label>
            <button id="confirmBtn" class="btn btn-primary w-100 d-block">Confirm</button>
          </div>
        </div>
        <div class="text-center mt-2">
          <small class="text-muted">
            <a href="#" onclick="showLogin()">Back to login</a>
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Messages -->
  <div id="statusMessage" class="mt-3 d-none">
    <div class="alert" id="statusAlert"></div>
  </div>
{% endblock %}

{% block head_extra %}
<!-- Font Awesome for Google icon -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block scripts %}
<script>
// Google OAuth Configuration 
const COGNITO_DOMAIN = 'ap-southeast-2vt6cuuzgl.auth.ap-southeast-2.amazoncognito.com'; 
const CLIENT_ID = 'r4jbveuntmkb7s5m6cotd6ere'; 
const REDIRECT_URI = window.location.origin + '/login';

let currentMfaSession = null;
let currentUsername = null;

// Google Login Functions
function loginWithGoogle() {
  const googleAuthUrl = `https://${COGNITO_DOMAIN}/oauth2/authorize?` +
    `identity_provider=Google&` +
    `redirect_uri=${encodeURIComponent(REDIRECT_URI)}&` +
    `response_type=CODE&` +
    `client_id=${CLIENT_ID}&` +
    `scope=openid email profile`;
  
  window.location.href = googleAuthUrl;
}

// Check for OAuth callback on page load
function checkOAuthCallback() {
  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get('code');
  const error = urlParams.get('error');
  
  if (error) {
    showStatus(`Google login failed: ${error}`, true);
    window.history.replaceState({}, document.title, window.location.pathname);
    return;
  }
  
  if (code) {
    exchangeCodeForTokens(code);
  }
}

async function exchangeCodeForTokens(code) {
  try {
    showStatus('Completing Google login...', false);
    
    const data = await api('/auth/oauth/token', {
      method: 'POST',
      body: JSON.stringify({
        code: code,
        redirect_uri: REDIRECT_URI
      })
    });
    

    setToken(data.access_token);
    
    showStatus('Google login successful! Redirecting...', false);

    window.history.replaceState({}, document.title, window.location.pathname);
    
    setTimeout(() => {
      window.location.href = "/upload";
    }, 1000);
    
  } catch (e) {
    showStatus(`Google login failed: ${e.message}`, true);
    window.history.replaceState({}, document.title, window.location.pathname);
  }
}

function showLogin() {
  document.getElementById('loginSection').classList.remove('d-none');
  document.getElementById('signupSection').classList.add('d-none');
  document.getElementById('confirmSection').classList.add('d-none');
  document.getElementById('mfaSection').classList.add('d-none');
  hideStatus();
  // Reset MFA state
  currentMfaSession = null;
  currentUsername = null;
}

function showSignup() {
  document.getElementById('loginSection').classList.add('d-none');
  document.getElementById('signupSection').classList.remove('d-none');
  document.getElementById('confirmSection').classList.add('d-none');
  document.getElementById('mfaSection').classList.add('d-none');
  hideStatus();
}

function showConfirm() {
  document.getElementById('loginSection').classList.add('d-none');
  document.getElementById('signupSection').classList.add('d-none');
  document.getElementById('confirmSection').classList.remove('d-none');
  document.getElementById('mfaSection').classList.add('d-none');
  hideStatus();
}

function showMfa(session, username, message) {
  document.getElementById('loginSection').classList.add('d-none');
  document.getElementById('signupSection').classList.add('d-none');
  document.getElementById('confirmSection').classList.add('d-none');
  document.getElementById('mfaSection').classList.remove('d-none');
  
  // Store session and username
  currentMfaSession = session;
  currentUsername = username;
  
  document.getElementById('mfaMessage').innerHTML = `
    <strong>Email sent to your registered address</strong><br>
    ${message}
  `;
  document.getElementById('mfaCode').value = '';
  document.getElementById('mfaCode').focus();
  
  hideStatus();
}

function backToLogin() {
  showLogin();
  // Clear password
  document.getElementById('password').value = '';
}

function showStatus(message, isError = false) {
  const statusDiv = document.getElementById('statusMessage');
  const alertDiv = document.getElementById('statusAlert');
  alertDiv.textContent = message;
  alertDiv.className = isError ? 'alert alert-danger' : 'alert alert-success';
  statusDiv.classList.remove('d-none');
}

function hideStatus() {
  document.getElementById('statusMessage').classList.add('d-none');
}

async function handleSignup() {
  try {
    const username = document.getElementById('signupUsername').value.trim();
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value.trim();

    if (!username || !email || !password) {
      showStatus('Please fill in all fields', true);
      return;
    }

    const data = await api('/auth/signup', {
      method: 'POST',
      body: JSON.stringify({ username, email, password })
    });

    showStatus('Account created! Check your email for confirmation code.');
    document.getElementById('confirmUsername').value = username;
    setTimeout(() => showConfirm(), 2000);
    
  } catch (e) {
    showStatus(`Signup failed: ${e.message}`, true);
  }
}

async function handleConfirm() {
  try {
    const username = document.getElementById('confirmUsername').value.trim();
    const confirmation_code = document.getElementById('confirmCode').value.trim();

    if (!username || !confirmation_code) {
      showStatus('Please fill in all fields', true);
      return;
    }

    await api('/auth/confirm', {
      method: 'POST',
      body: JSON.stringify({ username, confirmation_code })
    });

    showStatus('Email confirmed! You can now login.');
    document.getElementById('username').value = username;
    setTimeout(() => showLogin(), 2000);
    
  } catch (e) {
    showStatus(`Confirmation failed: ${e.message}`, true);
  }
}

async function handleLogin() {
  try {
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();

    if (!username || !password) {
      showStatus('Please enter username and password', true);
      return;
    }

    const loginBtn = document.getElementById('loginFormBtn');
    const originalText = loginBtn.textContent;
    loginBtn.textContent = 'Sending email...';
    loginBtn.disabled = true;

    const data = await api("/auth/login", {
      method: "POST",
      body: JSON.stringify({ username, password }),
    });

    loginBtn.textContent = originalText;
    loginBtn.disabled = false;


    if (data.challenge_required) {
      showMfa(data.session, data.username, data.message);
    } else {
      // direct login - hope this should not happen :)
      console.log('Direct login success - MFA may not be configured properly');
      setToken(data.access_token);
      setTimeout(() => {
        window.location.href = "/upload";
      }, 1000);
    }
    
  } catch (e) {
    const loginBtn = document.getElementById('loginFormBtn');
    loginBtn.textContent = 'Login';
    loginBtn.disabled = false;

    if (e.message.includes('confirm') || e.message.includes('not confirmed')) {
      showStatus('Please confirm your email first', true);
      const username = document.getElementById("username").value.trim();
      document.getElementById('confirmUsername').value = username;
      showConfirm();
    } else {
      showStatus(`Login failed: ${e.message}`, true);
    }
  }
}

async function handleMfaChallenge() {
  try {
    const code = document.getElementById("mfaCode").value.trim();

    if (!code) {
      showStatus('Please enter the verification code', true);
      return;
    }

    if (code.length !== 6) {
      showStatus('Verification code must be 6 digits', true);
      return;
    }

    if (!currentMfaSession || !currentUsername) {
      showStatus('Session expired. Please login again.', true);
      showLogin();
      return;
    }

    const verifyBtn = document.getElementById('verifyMfaBtn');
    const originalText = verifyBtn.textContent;
    verifyBtn.textContent = 'Verifying...';
    verifyBtn.disabled = true;

    const data = await api("/auth/mfa/challenge", {
      method: "POST",
      body: JSON.stringify({ 
        session: currentMfaSession, 
        code: code,
        username: currentUsername
      }),
    });

    setToken(data.access_token);
    showStatus('MFA verification successful! Redirecting...');
    setTimeout(() => {
      window.location.href = "/upload";
    }, 1000);
    
  } catch (e) {
    const verifyBtn = document.getElementById('verifyMfaBtn');
    verifyBtn.textContent = 'Verify Code';
    verifyBtn.disabled = false;

    showStatus(`MFA verification failed: ${e.message}`, true);
    document.getElementById('mfaCode').value = '';
    document.getElementById('mfaCode').focus();
  }
}

document.getElementById("googleLoginBtn").addEventListener("click", loginWithGoogle);
document.getElementById("signupBtn").addEventListener("click", handleSignup);
document.getElementById("confirmBtn").addEventListener("click", handleConfirm);
document.getElementById("verifyMfaBtn").addEventListener("click", handleMfaChallenge);

document.getElementById("password").addEventListener("keypress", function(e) {
  if (e.key === "Enter") handleLogin();
});

document.getElementById("mfaCode").addEventListener("keypress", function(e) {
  if (e.key === "Enter") handleMfaChallenge();
});

document.getElementById("confirmCode").addEventListener("keypress", function(e) {
  if (e.key === "Enter") handleConfirm();
});


document.getElementById("mfaCode").addEventListener("input", function(e) {
  let value = e.target.value.replace(/\D/g, ''); 
  if (value.length > 6) value = value.substr(0, 6); 
  e.target.value = value;
});

document.getElementById("confirmCode").addEventListener("input", function(e) {
  let value = e.target.value.replace(/\D/g, ''); 
  if (value.length > 6) value = value.substr(0, 6); 
  e.target.value = value;
});

document.addEventListener('DOMContentLoaded', checkOAuthCallback);
</script>
{% endblock %}