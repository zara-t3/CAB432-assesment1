{% extends "template.html" %}
{% block content %}
  <h1 class="h4 mb-3">Upload</h1>

  <!-- Local upload -->
  <div class="card mb-3">
    <div class="card-header">Upload local file</div>
    <div class="card-body">
      <div class="row g-2 align-items-center">
        <div class="col-12 col-md-4">
          <input id="nameInput" type="text" class="form-control" placeholder="Image name" required />
        </div>
        <div class="col-12 col-md-4">
          <input id="fileInput" type="file" class="form-control" accept="image/*" />
        </div>
        <div class="col-12 col-md-2 d-grid">
          <button id="uploadBtn" class="btn btn-secondary">Upload</button>
        </div>
        <div class="col-12 col-md-4">
          <span class="text-muted">New image: <code id="newImageId">—</code></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Preview card (appears after upload) -->
  <div id="previewCard" class="card d-none">
    <div class="card-body">
      <div class="d-flex align-items-start gap-3">
        <img id="previewImg" alt="preview" class="rounded border" style="max-width: 320px; height: auto;">
        <div class="flex-grow-1">
          <div class="mb-2 text-muted small">
            This is the server thumbnail. Open the original or run face‑blur, then view/download from <em>My Images</em>.
          </div>
          <div class="d-flex flex-wrap gap-2">
            <button id="viewOriginalBtn" class="btn btn-link p-0">View original</button>
            <button id="blurBtn" class="btn btn-dark">Blur faces</button>
            <a href="/images" class="btn btn-outline-secondary">Go to My Images</a>
          </div>
          <div id="previewStatus" class="text-muted small mt-2"></div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
// ---------- Upload ----------
document.getElementById("uploadBtn").addEventListener("click", async () => {
  const name = document.getElementById("nameInput").value.trim();
  const file = document.getElementById("fileInput").files[0];
  if (!name || !file) {
    alert("Please enter a name and choose a file");
    return;
  }

  const form = new FormData();
  form.append("name", name);
  form.append("file", file);

  try {
    const j = await api("/images", { method: "POST", body: form });
    document.getElementById("newImageId").textContent = `${j.name} (${j.id})`;
    localStorage.setItem('last_image_id', j.id);
    await showPreview(j.id);
  } catch (e) {
    alert("Upload failed: " + e.message);
  }
});

// ---------- Preview helpers ----------
async function showPreview(imageId) {
  const card = document.getElementById("previewCard");
  const status = document.getElementById("previewStatus");
  const img = document.getElementById("previewImg");

  card.classList.remove("d-none");
  status.textContent = "Loading preview…";
  img.src = "";

  try {
    const token = getToken();
    const res = await fetch(`${BASE}/images/${imageId}/file?version=thumb`, {
      headers: { Authorization: "Bearer " + token }
    });
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    img.src = url;
    img.onload = () => setTimeout(() => URL.revokeObjectURL(url), 10000);

    // Wire buttons
    document.getElementById("viewOriginalBtn").onclick = () => openImage(imageId, "original");
    document.getElementById("blurBtn").onclick = () => blurImage(imageId);
    status.textContent = "";
  } catch (e) {
    card.classList.add("d-none");
    alert("Preview failed: " + e.message);
  }
}

async function blurImage(imageId) {
  try {
    const j = await api("/jobs", {
      method: "POST",
      body: JSON.stringify({ image_id: imageId, extra_passes: 2, blur_strength: 12 })
    });
    document.getElementById("previewStatus").textContent =
      `Blurred: job_id=${j.job_id}, duration_ms=${j.duration_ms}. Check "My Images" for the processed version.`;
  } catch (e) {
    alert("Face blur failed: " + e.message);
  }
}

// Open helper (authorized)
async function openImage(id, version) {
  const token = getToken();
  if (!token) return window.location.href = "/login";
  const res = await fetch(`${BASE}/images/${id}/file?version=${encodeURIComponent(version)}`, {
    headers: { Authorization: "Bearer " + token }
  });
  if (!res.ok) return alert(`Open failed: ${res.status} ${res.statusText}`);
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  window.open(url, "_blank");
  setTimeout(() => URL.revokeObjectURL(url), 10000);
}
</script>
{% endblock %}
