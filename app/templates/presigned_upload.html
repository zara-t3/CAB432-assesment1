{% extends "template.html" %}
{% block content %}
  <h1 class="h4 mb-3">Direct S3 Upload Test</h1>
  
  <div class="card">
    <div class="card-header">Pre-signed URL Upload (Direct to S3)</div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-12 col-md-4">
          <label class="form-label">Image Name</label>
          <input id="imageName" type="text" class="form-control" placeholder="My awesome image">
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Image File</label>
          <input id="imageFile" type="file" class="form-control" accept="image/*">
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">&nbsp;</label>
          <button id="uploadBtn" class="btn btn-primary w-100 d-block">Upload Direct to S3</button>
        </div>
      </div>
      
      <div id="uploadResult" class="mt-3"></div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  document.getElementById('uploadBtn').addEventListener('click', async () => {
    const name = document.getElementById('imageName').value.trim();
    const file = document.getElementById('imageFile').files[0];
    
    if (!name || !file) {
      alert('Please enter a name and select a file');
      return;
    }
    
    const resultDiv = document.getElementById('uploadResult');

    try {
      resultDiv.innerHTML = '';

      const uploadData = await api('/images/presigned-upload', {
        method: 'POST',
        body: JSON.stringify({
          name: name,
          content_type: file.type
        })
      });

      const formData = new FormData();
      Object.keys(uploadData.presigned_upload.fields).forEach(key => {
        formData.append(key, uploadData.presigned_upload.fields[key]);
      });
      formData.append('file', file);

      const s3Response = await fetch(uploadData.presigned_upload.url, {
        method: 'POST',
        body: formData
      });

      if (!s3Response.ok) {
        const errorText = await s3Response.text();
        throw new Error(`S3 upload failed: ${s3Response.status} - ${errorText}`);
      }

      const confirmResponse = await api(`/images/${uploadData.image_id}/confirm-upload`, {
        method: 'POST',
        body: JSON.stringify({
          name: name,
          s3_key: uploadData.s3_key
        })
      });

      resultDiv.innerHTML = `
        <div class="alert alert-success">
          <h6>Upload Successful!</h6>
          <p class="mb-0">Image uploaded directly to S3: <strong>${confirmResponse.name}</strong></p>
          <small>Image ID: ${confirmResponse.id}</small><br>
          <a href="/images" class="btn btn-sm mt-2" style="background-color: #e91e63; color: white; border: 1px solid #e91e63;">View in Images</a>
        </div>
      `;
      
      document.getElementById('imageName').value = '';
      document.getElementById('imageFile').value = '';
      
    } catch (error) {
      console.error('Upload error:', error);

      resultDiv.innerHTML = `
        <div class="alert alert-danger">
          <h6>Upload Failed</h6>
          <p class="mb-0">${error.message}</p>
        </div>
      `;
    }
  });
</script>
{% endblock %}