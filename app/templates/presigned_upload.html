{% extends "template.html" %}
{% block content %}
  <h1 class="h4 mb-3">Direct S3 Upload Test</h1>
  
  <div class="card">
    <div class="card-header">Pre-signed URL Upload (Direct to S3)</div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-12 col-md-4">
          <label class="form-label">Image Name</label>
          <input id="imageName" type="text" class="form-control" placeholder="My awesome image">
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Image File</label>
          <input id="imageFile" type="file" class="form-control" accept="image/*">
        </div>
        <div class="col-12 col-md-4 d-flex align-items-end">
          <button id="uploadBtn" class="btn btn-primary w-100">Upload Direct to S3</button>
        </div>
      </div>
      
      <div id="uploadProgress" class="mt-3" style="display: none;">
        <div class="progress">
          <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
        </div>
        <small id="progressText" class="text-muted">Preparing upload...</small>
      </div>
      
      <div id="uploadResult" class="mt-3"></div>
    </div>
  </div>
  
  <div class="card mt-3">
    <div class="card-header">Upload Methods Comparison</div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <h6>Traditional Upload (via server)</h6>
          <p class="small">Client → Your Server → S3 → DynamoDB</p>
          <a href="/upload" class="btn btn-outline-secondary btn-sm">Traditional Upload</a>
        </div>
        <div class="col-md-6">
          <h6>Pre-signed Upload (direct to S3)</h6>
          <p class="small">Client → S3 direct → Notify Server → DynamoDB</p>
          <button class="btn btn-primary btn-sm" disabled>You're Here</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  document.getElementById('uploadBtn').addEventListener('click', async () => {
    const name = document.getElementById('imageName').value.trim();
    const file = document.getElementById('imageFile').files[0];
    
    if (!name || !file) {
      alert('Please enter a name and select a file');
      return;
    }
    
    const progressDiv = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const resultDiv = document.getElementById('uploadResult');
    
    try {
      progressDiv.style.display = 'block';
      resultDiv.innerHTML = '';
      progressBar.style.width = '10%';
      progressText.textContent = 'Getting pre-signed URL...';
      
      const uploadData = await api('/images/presigned-upload', {
        method: 'POST',
        body: JSON.stringify({
          name: name,
          content_type: file.type
        })
      });
      
      progressBar.style.width = '30%';
      progressText.textContent = 'Uploading directly to S3...';
      
      const formData = new FormData();
      Object.keys(uploadData.presigned_upload.fields).forEach(key => {
        formData.append(key, uploadData.presigned_upload.fields[key]);
      });
      formData.append('file', file);
      
      const s3Response = await fetch(uploadData.presigned_upload.url, {
        method: 'POST',
        body: formData
      });
      
      if (!s3Response.ok) {
        const errorText = await s3Response.text();
        throw new Error(`S3 upload failed: ${s3Response.status} - ${errorText}`);
      }
      
      progressBar.style.width = '80%';
      progressText.textContent = 'Confirming upload with server...';
      
      const confirmResponse = await api(`/images/${uploadData.image_id}/confirm-upload`, {
        method: 'POST',
        body: JSON.stringify({
          name: name,
          s3_key: uploadData.s3_key
        })
      });
      
      progressBar.style.width = '100%';
      progressBar.classList.add('bg-success');
      progressText.textContent = 'Upload completed!';
      
      resultDiv.innerHTML = `
        <div class="alert alert-success">
          <h6>Upload Successful!</h6>
          <p class="mb-0">Image uploaded directly to S3: <strong>${confirmResponse.name}</strong></p>
          <small>Image ID: ${confirmResponse.id}</small><br>
          <a href="/images" class="btn btn-sm btn-outline-primary mt-2">View in Images</a>
        </div>
      `;
      
      document.getElementById('imageName').value = '';
      document.getElementById('imageFile').value = '';
      
    } catch (error) {
      console.error('Upload error:', error);
      progressBar.classList.add('bg-danger');
      progressText.textContent = 'Upload failed';
      
      resultDiv.innerHTML = `
        <div class="alert alert-danger">
          <h6>Upload Failed</h6>
          <p class="mb-0">${error.message}</p>
        </div>
      `;
    }
  });
</script>
{% endblock %}